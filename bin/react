#!/usr/bin/env python

from rxn_ca.computing.schemas.enumerated_rxns_schema import EnumeratedRxnsModel
from rxn_ca.core.recipe import ReactionRecipe

from rxn_ca.utilities.single_sim import run_single_sim
from rxn_ca.utilities.parallel_sim import run_sim_parallel
from rxn_ca.utilities.prints import print_banner

from pylattica.core import Simulation

import argparse
import os
import time

parser = argparse.ArgumentParser(
                    prog="Reaction Automaton",
                    description="Runs the rxn-ca automaton",
)

parser.add_argument('recipe_filename')
parser.add_argument('-d', '--input-dir')
parser.add_argument('-o', '--output-file')
parser.add_argument('-r', '--reactions-file')
parser.add_argument('-i', '--initial-simulation-file')

parser.add_argument('-s', '--single', default=False, action='store_true')

args = parser.parse_args()

output_file = args.output_file
recipe_filename = args.recipe_filename
reactions_filename = args.reactions_file
initial_simulation_filename = args.initial_simulation_file

print_banner()

print(f"Reading recipe from {recipe_filename}...")

if output_file is None:
    output_dir = os.path.dirname(recipe_filename)

    prefix = recipe_filename.split(".")[0]
    output_fname = prefix + "-" + time.strftime("%Y-%m-%d-%H%M%S") + '.json'
    output_file = os.path.join(output_dir, output_fname)

print(f"Choosing {output_file} as output location")

recipe = ReactionRecipe.from_file(recipe_filename)

if reactions_filename is not None:
    rxns: EnumeratedRxnsModel = EnumeratedRxnsModel.from_file(reactions_filename)
    reaction_set = rxns.rxn_set
    phases = rxns.phases
else:
    reaction_set = None
    phases = None

if initial_simulation_filename is not None:
    initial_simulation = Simulation.from_file(initial_simulation_filename)
else:
    initial_simulation = None

if args.single:
    result = run_single_sim(
        recipe,
        base_reactions=reaction_set,
        initial_simulation=initial_simulation,
        phase_set = phases
    )
else:
    result = run_sim_parallel(
        recipe,
        base_reactions=reaction_set,
        initial_simulation=initial_simulation,
        phase_set = phases
    )

print(f'================= SAVING RESULTS to {output_file} =================')

result.to_file(output_file)
